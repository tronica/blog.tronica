language: minimal
services:
- docker
fast_finish: true
addons:
  ssh_known_hosts: blog.tronica.io
before_install:
- openssl aes-256-cbc -K $encrypted_3eb3d26b78a7_key -iv $encrypted_3eb3d26b78a7_iv
  -in deploy_key.enc -out deploy_key -d
- chmod 600 ./deploy_key
- eval "$(ssh-agent -s)"
- DISPLAY=":0.0" SSH_ASKPASS="/tmp/askpass" setsid ssh-add ./deploy_key </dev/null
- sudo rm /usr/local/bin/docker-compose
- curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname
  -s`-`uname -m` > docker-compose
- chmod +x docker-compose
- sudo mv docker-compose /usr/local/bin
script:
- echo "MaxSessions 30" >>  /etc/ssh/sshd_config)
- service ssh restart
- echo "$(docker-compose -v)"
- docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
- docker build . -t patrixr/tronica
- docker push patrixr/tronica
- echo "Pushing to $REMOTE_HOST"
- docker-compose -H $REMOTE_HOST down
- docker-compose -H $REMOTE_HOST pull
- docker-compose -H $REMOTE_HOST up -d certbot
- docker-compose -H $REMOTE_HOST up -d mysql ghost nginx
env:
  global:
  - DOCKER_COMPOSE_VERSION=1.24.1
  - secure: ZwJ9JNYC5pxETifo07X9xMCbmXwGcPpkcZ/Lj+TGZ/2R/uDTizP7oVO7VAbOxN3zoqDRrMnZlhFr0FweNpzr/DHeak3cKsTi6Nu9jz20nb+5NiZxeQz5FoUwwM1dbsvL/Hkc+CvMYvQ6QNVtll5/RV1Oa/GT7jlnTXhp5DZqgQC6hy7/0rQkZ1GmHAyaO8CISP4xUYiRPbCQA20l/97sB0QAO0mpdunXG+L9EgHr+knR8zUsmK1ieQGvIgzpVTZbznTwn9rZ8Hz4rrJt08bKyZCuSZyBrHlKscQR6OskXvvyRUjEJb5989C3hMViKlYdb8YxhccJgiVEdZw74Z4rQtD22a//wLpVcAYTAUF3Fz4CdebmWzgzTIZ2IspzOlJwU1taj2pKsokrs7slXfQuxSGRrhZi4FVzdFOeFN67g6EXOdnvoZi5UB+TsVBQdn2qSDdp3+4IuXbzCOwG7Vfm949jEcyK3j+LL1udVn8UFZD1Dh4RJKDzwAaTvuoTfGNIbJE+rTqqQaoh9tPZo6oMc4hoMFxnWmAPWYFLq1cBEzSo9UPB/TP2zC8AYRJD+ncizjAeWRflXB0IlSD6McwSsj7tPfWr28cEya4PVcPV5Q2Qhj6hdZsWVXoyOn/pfqV+DuR79BDWxJa3BoRCUy7Ef7jfraXkJi4enjXzCSdqkoE=
  - secure: dc9sjXHmHbYpZakzf9EkCScOllRNI4r1hlsp/esQCKBo/knHvYV5gbuzsHRN6suO2iVOYQAYxzIyyL5xaiQa2rYKYoBnw2exVcFJPPhmWxJ4uwFxRDId6MoXEErOjx+MOCz61nSn2wArxELlHdH3nr0v2i2saD5caTJ9tVkJTDA+divbDUdG0Z4NceUdpT/4kL1fZKSuAO7WxvEk7mgxrIPWtrWPWqjbHZcInbUVoEABMYcTQKEHSPzh9L9VKy6MtUqFJi2IjU4atDe7J8hdWGmziZstONKnvRO5fh3hJr96fXOgdvuvfQp+GQujYg34e9aUswG8nO7cujk4Yw5zRGLItgJxP8THQIkeNNgcnPhkHWsQCd2z/jWxvg5qWJkN9L2WDIjWfCFpMgBN7Bz4bsDgbuskSLFZ54UELCNJb68sL0HeEwdLxET39gl0tt4nM6IWSpi8QJOgt/paUe7x2ycWAIplfOWxgy7C3f2wHsJZYFO4wacrTbkzPRM1M+EkP0A1mHCsAn1P7VSzKOBkZE2h+S86eER+hTD7KUiRrv9+84WRVhINEPy4dCd5bKT9I4U6MglfXy99I8/AO2nD2MFO/4YJ2XbFa1aucCSetMDE6aOSyuu45J8Ak5uNO9axh+QNcbZq+F014O4qvn/nvU+Q4+QtCBOCBhD/jx5Czvo=
  - secure: n11ZEB/CJvAbnDd3oRU25M6W+Hd+wWHUCEiWUmYmyr7mtPKLjJoR41WF/k3ut4ypwXGe9fk85Y4QuKxP6JPgf3c11qThdaipEehliShr7YgE7o3z0YJQwzJNJhNxHTQFlgcuYyXaFrlM4A74EDcGXe9Olu6RH7u/IIAzCPd7iheGPeAIaHyjdEkgKtD3VmY3iOL0ihvijXAKryHVkbTRftJpq2rc4Wjkk2Jc4xO0EfRImKe4fZTFCWUntZTr4wL5vRBD1sxnSixz9/Qv/4YiSZnntmLPfvDznMOGlESCgmMcq5gsKJS+/uLq4zGv2Hr4mkG3si8XqBcVytSoHCy6WM80epYfOQxVAk3JA5uQ9NooQUSFAZpRnshlMu8MiBpSRJ5peLUKs+kxHdGVUnP06t7+uBYoFg7tLADnIGY5ORPbajic8Oj1gyMbikSuh/XuXQtXrBnW1hRlhtOeMY/IuAym3Fh1UvtlDdXAi6bhZbEg1F65p73sbk8JQqsDOX0khjwmTdwo3E3e/SyiwnOx3UfYM3WmCif8XAuOHHdzPu0rxRxkZKJlZ63iKm3Fg9Hzdj9gCRh1EJkfXOC8VzQC5WABDVcEVHpONlez7KDufgae5vBAKR6QvLveA1Uaf+1Ivo4YliWWFr3jhmSyJhxRfc9okcjzWxjNYxbxHyX5VW8=
  - secure: H/qnxr6EmHv9PcH5MgcrtOsCAwk5TflpWeRi+7coeHE/zQ/O/VmWNaAQSSYXfmSkA0i9tXhHbo+oYD7aJsq/Hky5p3/CKA0MVZG9HWAqQV2YOvIS8inLs8g4E/Ou4nQ+D/U0TA+clwQ6IJ9Imk3j2aMbhibsN9ISnZPzDQhs/bvVOv/8i0IiLqupSZv+6EVrFT+9IS0R13uZzEFgyAXzb+felcki9QgXDdmjApsL0pnS4bkiPJf/IKj7tbXHg+A0wsRENarexWeQLo/A24sWZFEXX0+LmCf6flMHfVaKBDEYPzYmxeT5KfETm6T4yAiHcQYsQL699Za0fBwIJk1FX02tY9lISOI1N8fw7I2+/wTcwag7xZKPXYaHApweLJ2ZPvtWs15izTviCB5Ss1wtXn2eNq+2pacZTWQnDaPUDopGcHWY3SYhnt4t4aQEaSiFd2cI4fe3Ic5q1icgf9Diw+P2n43OVkfATSwayupjnCF4+KfCB38tYc2+F69SYORWykzXItLROkma/GDJAPeCNcAyq9BetLy7bY+YQ0Ku51SmcwEWRydnIUen/RmIo+/IAmd5cGvObwZOoRCnHeHMm8CL35vOWqSSFRqhXLidt3BiUZF+nQ33CCiXXh4C5dLi091sR+Y99W+mXGlN8cso34LCavH5rLwjSes7y89Nqx0=
  - secure: XXVR4Zl4wfW4PRo7sbTUQUZq0ToIiE7FczqEkQMeofSykW9F2YM6vvGvhjkEN9ixNZ0WVorAzK0Ziz7qcG2OzVJvn/Dad32YotFqhXxfXcp0akHuzP3MzOKcBfbd0LT890w5yiWlRP4qxWRq63JRoQnBuis6jCoWGiKA4zRE57f3owrJKFqlUepxkd6I8rbIuNjTUeCaQ4DFHUQ231Cje2E49hOYS3rAbRn9BQEHA0GPgLFKsBrbYi/+iso2x+5YFrRJXzeuvx+Ui3+fgavIV2LSQXJmX7VHu7UaE9LGQdynJQ7XeucETsj/1T1Qez5hFTgGpmUhuJ80+G7Odu/tyGLlXKvjuiR0e1yQOC07lEb/LhtxoalXGpuN0Uiws4Z8dwA7KPWR/yx2JJzezIsZJWZd4FGRx/Bdw7315R2HosfniKlFho5h+yVEafJT/Yb6+/55TCw5Wcumqz1jwibwjr+7CR0XkDe0sWL6FgHzgE6g7Qhm09sympFjAxL3MFIYrHE0ZsF2hjdkdRhrb1POPNcDOyPx0Rxt3WM+0q4DEP+V8wwWQfYxabb9YvcLbU765TC8COHnbwN0Y4YYLParyiYJEjZYr4W6u7kSLpoqOnQmbHyXCJMYK1rgEU/t0X0azkz4j/XtQCjFeGRyk1qFvfIghioO7qMiWhYtbs/a+hg=
